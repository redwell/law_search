# 技術アーキテクチャ (ARCHITECTURE.md)

## システム概要

本システムは、e-GovのXMLデータを活用した日本の法律検索システムです。全文検索・ベクトル検索・グラフ検索を組み合わせたハイブリッド検索により、一般ユーザーが自然言語で質問して法律情報を取得できることを目指します。

## 高レベルアーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   e-Gov XML     │───▶│   Data Pipeline │───▶│   ArangoDB      │
│   Data Source   │    │   (Processing)  │    │   (Storage)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
                                                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web UI        │◀───│   RAG System    │◀───│   Search Engine │
│   (Frontend)    │    │   (Backend)     │    │   (Hybrid)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 主要コンポーネント

### 1. データパイプライン (Data Pipeline)

#### 1.1 データ取得モジュール
- **目的**: e-GovからXMLデータを取得
- **実装**: Pythonスクリプトによる自動ダウンロード
- **スケジュール**: 定期的なバッチ実行（月1回）
- **データ形式**: XML（XSDスキーマ定義あり）

#### 1.2 データ前処理モジュール
- **目的**: XMLデータの解析・正規化・構造化
- **機能**:
  - XMLパースとスキーマ検証
  - テキストの正規化・クリーニング
  - 法律間の参照関係の抽出
  - 埋め込み生成用のテキスト分割

#### 1.3 埋め込み生成モジュール
- **目的**: 法律条文のベクトル表現を生成
- **モデル**: jinaai/jina-embeddings-v3
- **処理単位**: 条文単位（必要に応じて分割）
- **更新タイミング**: 新規データ取得時・モデル変更時

### 2. データストレージ (ArangoDB)

#### 2.1 コレクション設計
```javascript
// 法律文書コレクション
documents: {
  _key: "law_001_article_001",
  law_name: "所得税法",
  article_number: "第1条",
  content: "条文の内容",
  embedding: [0.1, 0.2, ...], // ベクトル埋め込み
  metadata: {
    law_id: "law_001",
    chapter: "第1章",
    section: "第1節",
    effective_date: "2024-01-01"
  }
}

// 法律間の関係性エッジ
law_relationships: {
  _from: "laws/law_001",
  _to: "laws/law_002",
  relationship_type: "reference", // reference, amendment, repeal
  description: "参照関係の説明"
}

// 条文間の関係性エッジ
article_relationships: {
  _from: "documents/law_001_article_001",
  _to: "documents/law_002_article_005",
  relationship_type: "reference",
  context: "参照の文脈"
}
```

#### 2.2 インデックス設計
- **全文検索インデックス**: 条文内容の全文検索用
- **ベクトルインデックス**: 埋め込みベクトルの類似検索用
- **グラフインデックス**: 関係性の高速検索用
- **複合インデックス**: 法律名・条番号・日付の組み合わせ検索用

### 3. 検索エンジン (Hybrid Search)

#### 3.1 全文検索
- **実装**: ArangoDBのAQL全文検索機能
- **用途**: キーワードベースの検索
- **特徴**: 高速・正確な文字列マッチング

#### 3.2 ベクトル検索
- **実装**: ArangoDBのベクトル検索機能
- **用途**: 意味的類似性による検索
- **特徴**: 自然言語の意味理解

#### 3.3 グラフ検索
- **実装**: ArangoDBのグラフトラバーサル
- **用途**: 関連条文・法律の検索
- **特徴**: 関係性に基づく探索

#### 3.4 ハイブリッド検索戦略
```python
def hybrid_search(query: str, limit: int = 10):
    # 1. 全文検索
    fulltext_results = fulltext_search(query, limit * 2)
    
    # 2. ベクトル検索
    vector_results = vector_search(query, limit * 2)
    
    # 3. グラフ検索（関連条文）
    graph_results = graph_search(query, limit * 2)
    
    # 4. 結果の統合・重み付け
    combined_results = combine_and_rank(
        fulltext_results, vector_results, graph_results
    )
    
    return combined_results[:limit]
```

### 4. RAGシステム (Retrieval-Augmented Generation)

#### 4.1 質問理解モジュール
- **目的**: ユーザーの質問を解析・理解
- **機能**:
  - 質問の意図抽出
  - 関連する法律領域の特定
  - 検索クエリの生成

#### 4.2 文脈構築モジュール
- **目的**: 検索結果から回答生成用の文脈を構築
- **機能**:
  - 関連条文の選択・統合
  - 文脈の最適化
  - 引用元の整理

#### 4.3 回答生成モジュール
- **目的**: 自然言語での回答生成
- **モデル**: ChatGPT API
- **機能**:
  - 一般ユーザー向けの分かりやすい説明
  - 引用元の明示
  - 関連情報の提供

### 5. Webインターフェース

#### 5.1 フロントエンド
- **技術**: 未定（React/Vue.js/Next.js候補）
- **機能**:
  - 質問入力フォーム
  - 回答表示
  - 引用元の表示
  - 関連条文の表示

#### 5.2 バックエンドAPI
- **技術**: 未定（FastAPI/Django/Flask候補）
- **エンドポイント**:
  - `POST /api/query`: 質問応答
  - `GET /api/laws`: 法律一覧
  - `GET /api/articles/{id}`: 条文詳細
  - `GET /api/related/{id}`: 関連条文

## データフロー

### 1. データ取得フロー
```
e-Gov XML → ダウンロード → 前処理 → 埋め込み生成 → ArangoDB格納
```

### 2. 質問応答フロー
```
ユーザー質問 → 質問理解 → ハイブリッド検索 → 文脈構築 → 回答生成 → 回答表示
```

### 3. 検索フロー
```
検索クエリ → 全文検索 + ベクトル検索 + グラフ検索 → 結果統合 → ランキング
```

## 技術スタック詳細

### データベース
- **ArangoDB**: 3.11以上
- **設定**: Dockerコンテナ
- **バックアップ**: 定期的なダンプ

### AI・機械学習
- **埋め込みモデル**: jinaai/jina-embeddings-v3
- **言語モデル**: OpenAI GPT-4
- **RAGフレームワーク**: langchain + langgraph

### 開発・運用
- **Python**: 3.11以上
- **パッケージ管理**: uv
- **コンテナ**: Docker + docker-compose
- **CI/CD**: GitHub Actions
- **監視**: 基本的なログ・メトリクス

## パフォーマンス要件

### レスポンス時間
- **質問応答**: 平均3秒以内
- **検索**: 平均1秒以内
- **データ更新**: バッチ処理（非同期）

### スループット
- **同時ユーザー**: 100人
- **1日あたりの質問**: 1,000件
- **データ更新頻度**: 月1回

### 可用性
- **稼働率**: 99%以上
- **ダウンタイム**: 月4時間以内
- **バックアップ**: 日次

## セキュリティ

### データ保護
- **暗号化**: 転送時・保存時の暗号化
- **アクセス制御**: API認証・認可
- **監査ログ**: アクセス・操作の記録

### プライバシー
- **個人情報**: 最小限の収集
- **ログ**: 個人を特定できない形式
- **データ保持**: 必要最小限の期間

## スケーラビリティ

### 水平スケーリング
- **アプリケーション**: 複数インスタンス
- **データベース**: レプリケーション
- **ロードバランサ**: 負荷分散

### 垂直スケーリング
- **CPU**: 必要に応じて増強
- **メモリ**: キャッシュ最適化
- **ストレージ**: 容量拡張

## 監視・運用

### メトリクス
- **システム**: CPU・メモリ・ディスク使用率
- **アプリケーション**: レスポンス時間・エラー率
- **ビジネス**: 質問数・回答精度・ユーザー満足度

### アラート
- **システム障害**: 自動通知
- **パフォーマンス劣化**: 閾値ベース
- **データ更新失敗**: 即座に通知

---

*このドキュメントはリビングドキュメントです。技術的な変更や改善に合わせて継続的に更新されます。*
